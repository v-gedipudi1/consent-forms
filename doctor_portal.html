<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealMed Clinic Doctor Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for client-side PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 30px -30px; /* Adjust for padding of container */
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 300;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            margin-left: 15px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fef08a; /* Yellow for warning/loading */
            border: 1px solid #facc15;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            text-align: center;
            font-size: 1.1em;
            color: #b45309;
        }
        .message-box.error {
            background-color: #fef2f2; /* Light red for error */
            border-color: #ef4444; /* Red border */
            color: #dc2626; /* Darker red text */
        }
        .message-box.success {
            background-color: #f0fdf4; /* Light green for success */
            border-color: #10b981; /* Green border */
            color: #047857; /* Darker green text */
        }

        .data-section {
            margin-top: 20px;
            border-top: 1px solid #e1e8ed;
            padding-top: 20px;
        }

        .patient-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 5px solid #3498db;
        }

        .patient-card h4 {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .patient-card p {
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .patient-card p strong {
            color: #555;
            min-width: 150px;
            display: inline-block;
        }

        .patient-card .actions {
            margin-top: 15px;
            text-align: right;
        }

        .action-button {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:hover {
            background: #2ecc71;
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background: #c0392b;
        }

        /* Styling for the PDF export content */
        .pdf-content {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: #333;
            padding: 20px;
        }
        .pdf-content h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .pdf-content h3 {
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #3498db;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .pdf-content p {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        .pdf-content p strong {
            font-weight: 600;
            min-width: 120px;
            display: inline-block;
        }
        .pdf-content .indent {
            margin-left: 20px;
            margin-bottom: 5px;
        }
        .pdf-content .indent strong {
             min-width: 100px;
             display: inline-block;
        }
    </style>
</head>
<body>
    <button id="logoutButton" class="logout-button hidden">Logout</button>

    <div id="loginSection" class="container">
        <div class="header">
            <h1>Doctor Portal Login</h1>
            <p>HealMed Clinic</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email (Username):</label>
                <input type="email" id="loginEmail" value="admin" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="loginPassword" value="healthcare2024" required>
            </div>
            <button type="submit" class="btn-primary w-full">Login</button>
        </form>
    </div>

    <div id="portalSection" class="container hidden">
        <div class="header">
            <h1>Patient Consent Forms</h1>
            <p>View and Download Submissions</p>
        </div>
        <div id="patientFormsContainer" class="data-section">
            <!-- Patient forms will be loaded here -->
            <p>Loading patient data...</p>
        </div>
    </div>

    <!-- Message Box for Success/Error/Loading -->
    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDK - IMPORTANT: Replace with your actual config -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Your Firebase configuration (from Step 1.3)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            // measurementId: "YOUR_MEASUREMENT_ID" // Optional, if you enabled Analytics
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginSection = document.getElementById('loginSection');
        const portalSection = document.getElementById('portalSection');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const patientFormsContainer = document.getElementById('patientFormsContainer');
        const messageBox = document.getElementById('messageBox');
        const logoutButton = document.getElementById('logoutButton');

        function showMessage(message, type = 'info') { // type can be 'info', 'success', 'error'
            messageBox.textContent = message;
            messageBox.className = 'message-box'; // Reset classes
            if (type === 'error') {
                messageBox.classList.add('error');
            } else if (type === 'success') {
                messageBox.classList.add('success');
            }
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // --- Authentication Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;

            showMessage('Logging in...', 'info');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Login Error: ", error.code, error.message);
                showMessage(`Login failed: ${error.message}`, 'error');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Logout Error: ", error.message);
                showMessage(`Logout failed: ${error.message}`, 'error');
            }
        });

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in (doctor)
                loginSection.classList.add('hidden');
                portalSection.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                fetchPatientForms(); // Fetch data once logged in
            } else {
                // User is signed out
                loginSection.classList.remove('hidden');
                portalSection.classList.add('hidden');
                logoutButton.classList.add('hidden');
                patientFormsContainer.innerHTML = '<p>Please login to view patient data.</p>';
            }
        });

        // --- Fetch Patient Forms Logic ---
        async function fetchPatientForms() {
            patientFormsContainer.innerHTML = '<p>Loading patient data...</p>'; // Show loading message
            try {
                // Query the 'consentForms' collection
                const q = query(collection(db, "consentForms"), orderBy("submissionTimestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    patientFormsContainer.innerHTML = '<p>No consent forms found.</p>';
                    return;
                }

                patientFormsContainer.innerHTML = ''; // Clear loading message

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const formId = doc.id; // Document ID for reference

                    const patientCard = document.createElement('div');
                    patientCard.className = 'patient-card';
                    patientCard.id = `form-${formId}`; // Assign ID for PDF generation

                    // Format timestamp
                    const submissionDate = data.submissionTimestamp ? new Date(data.submissionTimestamp).toLocaleString() : 'N/A';

                    // Prepare content for display and PDF
                    let contentHtml = `
                        <h4>Consent Form Submission (${formId})</h4>
                        <p><strong>Submitted On:</strong> ${submissionDate}</p>
                        <h3>Personal Information</h3>
                        <p><strong>Full Name:</strong> ${data.fullName || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${data.gender || 'N/A'}</p>
                        <p><strong>Date of Birth:</strong> ${data.dob || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                        <h3>Screening Questionnaire</h3>
                        <p><strong>1) Epilepsy:</strong> ${data.q1_epilepsy || 'N/A'}</p>
                        ${data.q1_epilepsy === 'Yes' && data.q1_details ? `<p class="indent"><strong>Details:</strong> ${data.q1_details}</p>` : ''}
                        <p><strong>2) Convulsion/Seizure:</strong> ${data.q2_seizure || 'N/A'}</p>
                        ${data.q2_seizure === 'Yes' && data.q2_details ? `<p class="indent"><strong>Details:</strong> ${data.q2_details}</p>` : ''}
                        <p><strong>3) Family Epilepsy:</strong> ${data.q3_family_epilepsy || 'N/A'}</p>
                        ${data.q3_family_epilepsy === 'Yes' && data.q3_details ? `<p class="indent"><strong>Details:</strong> ${data.q3_details}</p>` : ''}
                        <p><strong>4) Lost Consciousness:</strong> ${data.q4_consciousness || 'N/A'}</p>
                        ${data.q4_consciousness === 'Yes' && data.q4_details ? `<p class="indent"><strong>Details:</strong> ${data.q4_details}</p>` : ''}
                        <p><strong>5) Severe Head Trauma:</strong> ${data.q5_head_trauma || 'N/A'}</p>
                        ${data.q5_head_trauma === 'Yes' && data.q5_details ? `<p class="indent"><strong>Details:</strong> ${data.q5_details}</p>` : ''}
                        <p><strong>6) Stroke:</strong> ${data.q6_stroke || 'N/A'}</p>
                        ${data.q6_stroke === 'Yes' && data.q6_details ? `<p class="indent"><strong>Details:</strong> ${data.q6_details}</p>` : ''}
                        <p><strong>7) Head Surgery:</strong> ${data.q7_head_surgery || 'N/A'}</p>
                        ${data.q7_head_surgery === 'Yes' && data.q7_details ? `<p class="indent"><strong>Details:</strong> ${data.q7_details}</p>` : ''}
                        <p><strong>8) Implants:</strong> ${data.implants && data.implants.length > 0 ? data.implants.join(', ') : 'None'}</p>
                        ${data.q8_details ? `<p class="indent"><strong>Implant Details:</strong> ${data.q8_details}</p>` : ''}
                        <p><strong>9) Spinal/Brain Deviations:</strong> ${data.q9_deviations || 'N/A'}</p>
                        ${data.q9_deviations === 'Yes' && data.q9_details ? `<p class="indent"><strong>Details:</strong> ${data.q9_details}</p>` : ''}
                        <p><strong>10) Hearing Disabilities/Tinnitus:</strong> ${data.q10_hearing || 'N/A'}</p>
                        ${data.q10_hearing === 'Yes' && data.q10_details ? `<p class="indent"><strong>Details:</strong> ${data.q10_details}</p>` : ''}
                        <p><strong>11) Neurological Illness:</strong> ${data.q11_neurological || 'N/A'}</p>
                        ${data.q11_neurological === 'Yes' && data.q11_details ? `<p class="indent"><strong>Details:</strong> ${data.q11_details}</p>` : ''}
                        <p><strong>12) Severe Headaches:</strong> ${data.q12_headaches || 'N/A'}</p>
                        ${data.q12_headaches === 'Yes' && data.q12_details ? `<p class="indent"><strong>Details:</strong> ${data.q12_details}</p>` : ''}
                        <p><strong>13) Medical Treatment:</strong> ${data.q13_treatment || 'N/A'}</p>
                        ${data.q13_treatment === 'Yes' && data.q13_details ? `<p class="indent"><strong>Details:</strong> ${data.q13_details}</p>` : ''}
                        <p><strong>14) Antibiotics:</strong> ${data.q14_antibiotics || 'N/A'}</p>
                        <p><strong>15) Antihistamines:</strong> ${data.q15_antihistamines || 'N/A'}</p>
                        ${data.q15_antihistamines === 'Yes' && data.q15_details ? `<p class="indent"><strong>Details:</strong> ${data.q15_details}</p>` : ''}
                        <p><strong>16) Other Medications:</strong> ${data.q16_other_meds || 'N/A'}</p>
                        ${data.q16_other_meds === 'Yes' && data.q16_details ? `<p class="indent"><strong>Details:</strong> ${data.q16_details}</p>` : ''}
                        <p><strong>17) Chronic Illness/Disorder:</strong> ${data.q17_chronic || 'N/A'}</p>
                        ${data.q17_chronic === 'Yes' && data.q17_details ? `<p class="indent"><strong>Details:</strong> ${data.q17_details}</p>` : ''}
                        <p><strong>18) Psychiatric Illness/Disorder:</strong> ${data.q18_psychiatric || 'N/A'}</p>
                        ${data.q18_psychiatric === 'Yes' && data.q18_details ? `<p class="indent"><strong>Details:</strong> ${data.q18_details}</p>` : ''}
                        <p><strong>19) Family Psychiatric Illness:</strong> ${data.q19_family_psychiatric || 'N/A'}</p>
                        ${data.q19_family_psychiatric === 'Yes' && data.q19_details ? `<p class="indent"><strong>Details:</strong> ${data.q19_details}</p>` : ''}
                        ${data.q19_family_psychiatric === 'Yes' && data.q19_relation ? `<p class="indent"><strong>Relation:</strong> ${data.q19_relation}</p>` : ''}
                        <p><strong>20) Recreational Drugs (Past Year):</strong> ${data.q20_drugs || 'N/A'}</p>
                        ${data.q20_drugs === 'Yes' && data.q20_details ? `<p class="indent"><strong>Details:</strong> ${data.q20_details}</p>` : ''}
                        <p><strong>22) Substance Dependence/Abuse:</strong> ${data.q22_substance_abuse || 'N/A'}</p>
                        ${data.q22_substance_abuse === 'Yes' && data.q22_details ? `<p class="indent"><strong>Details:</strong> ${data.q22_details}</p>` : ''}
                        <p><strong>23) Alcohol Consumption (&gt;3 units/day):</strong> ${data.q23_alcohol || 'N/A'}</p>
                        <p><strong>24) Sleeping Problems:</strong> ${data.q24_sleep || 'N/A'}</p>
                        ${data.q24_sleep === 'Yes' && data.q24_details ? `<p class="indent"><strong>Details:</strong> ${data.q24_details}</p>` : ''}
                        <p><strong>25) Pregnant/Chance:</strong> ${data.q25_pregnant || 'N/A'}</p>
                        <p><strong>26) Undergone MRI:</strong> ${data.q26_mri || 'N/A'}</p>
                        ${data.q26_mri === 'Yes' && data.q26_details ? `<p class="indent"><strong>Details:</strong> ${data.q26_details}</p>` : ''}
                        <p><strong>27) Undergone TMS:</strong> ${data.q27_tms || 'N/A'}</p>
                        ${data.q27_tms === 'Yes' && data.q27_details ? `<p class="indent"><strong>Details:</strong> ${data.q27_details}</p>` : ''}
                        <h3>Consent and Signature</h3>
                        <p><strong>Patient Signature:</strong> ${data.patientSignature || 'N/A'}</p>
                        <p><strong>Signature Date:</strong> ${data.signatureDate || 'N/A'}</p>
                        <div class="actions">
                            <button class="action-button" onclick="generatePdf('${formId}', '${data.fullName || 'Unknown Patient'} - ${submissionDate}')">Download PDF</button>
                        </div>
                    `;

                    patientCard.innerHTML = contentHtml;
                    patientFormsContainer.appendChild(patientCard);
                });

            } catch (error) {
                console.error("Error fetching documents: ", error);
                showMessage(`Error loading forms: ${error.message}`, 'error');
            }
        }

        // --- PDF Generation Logic ---
        window.generatePdf = async (formId, filename) => {
            showMessage('Generating PDF...', 'info');
            const element = document.getElementById(`form-${formId}`);
            if (!element) {
                showMessage('Error: Form content not found for PDF generation.', 'error');
                return;
            }

            // Create a temporary div to hold the content for PDF to avoid styling issues with parent containers
            const tempDiv = document.createElement('div');
            tempDiv.className = 'pdf-content'; // Apply PDF-specific styles
            tempDiv.innerHTML = element.innerHTML; // Copy content

            // Remove the download button from the temporary div
            const actionButtonDiv = tempDiv.querySelector('.actions');
            if (actionButtonDiv) {
                actionButtonDiv.remove();
            }

            document.body.appendChild(tempDiv); // Append to body (can be hidden) for html2canvas to render correctly

            try {
                const canvas = await html2canvas(tempDiv, {
                    scale: 2, // Increase scale for better resolution
                    useCORS: true, // If any external images are used (though none expected here)
                    logging: false, // Disable html2canvas logging if desired
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: 'a4'
                });

                const imgWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`${filename}.pdf`);
                showMessage('PDF generated successfully!', 'success');
            } catch (err) {
                console.error("Error generating PDF: ", err);
                showMessage(`Failed to generate PDF: ${err.message}`, 'error');
            } finally {
                // Clean up the temporary div
                if (tempDiv.parentNode) {
                    tempDiv.parentNode.removeChild(tempDiv);
                }
            }
        };
    </script>
</body>
</html>
